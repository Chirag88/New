//
//  MSAPersonalViewController.m
//  MySchapp
//
//  Created by CK-Dev on 25/03/16.
//  Copyright Â© 2016 ACA. All rights reserved.
//

#import "MSAPersonalViewController.h"
#import "MSAConstants.h"
#import "MSANetworkHandler.h"
#import "MSALoginDecision.h"
#import "MSASecurityViewController.h"
#import "MSAUtils.h"

@interface MSAPersonalViewController ()<LoginDecisionDelegate,MSANetworkDelegate>
{
    NSMutableDictionary *personalDetails;
}
- (IBAction)openSecurityScreen:(id)sender;
@end

@implementation MSAPersonalViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    self.navigationController.navigationBarHidden = NO;
    self.navigationItem.title = @"Profile";
    
    NSString *urlString = [NSString stringWithFormat:@"%@",[NSString stringWithFormat:@"%@%@",BASEURL,PERSONALURL]];
    MSANetworkHandler *networkHanlder = [[MSANetworkHandler alloc] init];
    networkHanlder.delegate = self;
    NSDictionary *reqHeadDict = @{@"Authorization":[NSString stringWithFormat:@"bearer %@",[[NSUserDefaults standardUserDefaults] valueForKey:kAccessToken]]};
    [networkHanlder createRequestForURLString:urlString withIdentifier:@"Personal" requestHeaders:reqHeadDict andRequestParameters:@{@"countrycodeid":self.selectedCountryId,@"planid":self.selectedPlanId} inView:self.view];
}

#pragma mark - MSANetworkDelegate

- (void)didReceiveData:(NSData *)responseData forRequest:(NSString *)requestId
{
    //received response comes here
    NSError* err;
    NSDictionary *responseDict = [NSJSONSerialization JSONObjectWithData:responseData options:0 error:&err];
    
    NSLog(@"%@",responseDict);
    if([[responseDict valueForKey:@"rCode"] isEqualToString:@"00"]) {
        NSLog(@"Got Personal data");
        personalDetails = [NSMutableDictionary dictionaryWithDictionary:responseDict];
    }
    else {
        [MSAUtils showAlertWithTitle:kAlertMessageTitle message:[responseDict valueForKey:@"rMsg"] cancelButton:kAlertOkButtonTitle otherButton:nil delegate:self];
    }
    
}

-(void)didFailWithError:(NSError *)error forRequest:(NSString *)requestId
{
      [MSAUtils showAlertWithTitle:kAlertMessageTitle message:kAlertInternalErrorMsg cancelButton:kAlertOkButtonTitle otherButton:nil delegate:self];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma LoginDecision Delegate
- (void)redirectToPage:(NSString *)pageToBeOpened {
    if ([pageToBeOpened isEqualToString:kLoginScreen]) {
        [self.navigationController popToRootViewControllerAnimated:NO];
        
    }
    else if ([pageToBeOpened isEqualToString:kCountrySelectionScreen])
    {
        UIStoryboard *mainStoryboard = UISTORYBOARD;
        
        MSASecurityViewController *controller = (MSASecurityViewController*)[mainStoryboard
                                                                             instantiateViewControllerWithIdentifier:@"MSASecurityViewController"];
        controller.personalData = personalDetails;
        [self.navigationController pushViewController:controller animated:YES];
    }
}



- (IBAction)openSecurityScreen:(id)sender {
    MSALoginDecision *loginDecision = [[MSALoginDecision alloc]init];
    loginDecision.delegate = self;
    [loginDecision checkLoginCriteria];

    
}
@end
